# è®¡ç®—æµåŠ¨æ€§

æ²¡æœ‰æµåŠ¨æ€§å°±æ— æ³•è¿›è¡Œäº¤æ˜“ï¼Œä¸ºäº†è¿›è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡äº¤æ¢ï¼Œæˆ‘ä»¬éœ€è¦å‘æ± åˆçº¦ä¸­æ³¨å…¥ä¸€äº›æµåŠ¨æ€§ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“çš„å‘æ± åˆçº¦æ·»åŠ æµåŠ¨æ€§çš„ä¿¡æ¯ï¼š

1. ä»·æ ¼èŒƒå›´ã€‚ä½œä¸ºæµåŠ¨æ€§æä¾›è€…ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç‰¹å®šçš„ä»·æ ¼èŒƒå›´å†…æä¾›æµåŠ¨æ€§ï¼Œå®ƒåªä¼šåœ¨è¿™ä¸ªèŒƒå›´å†…ä½¿ç”¨ã€‚

2. æµåŠ¨æ€§æ•°é‡ï¼Œå³ä¸¤ç§ä»£å¸çš„æ•°é‡ã€‚æˆ‘ä»¬éœ€è¦å°†è¿™äº›æ•°é‡çš„ä»£å¸è½¬ç§»åˆ°æ± åˆçº¦ä¸­ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‰‹åŠ¨è®¡ç®—è¿™äº›ï¼Œä½†åœ¨åŽé¢çš„ç« èŠ‚ä¸­ï¼Œåˆçº¦å°†ä¸ºæˆ‘ä»¬å®Œæˆè¿™é¡¹å·¥ä½œã€‚è®©æˆ‘ä»¬ä»Žä»·æ ¼èŒƒå›´å¼€å§‹ã€‚

## ä»·æ ¼èŒƒå›´è®¡ç®—

å›žæƒ³ä¸€ä¸‹ï¼Œåœ¨Uniswap V3ä¸­ï¼Œæ•´ä¸ªä»·æ ¼èŒƒå›´è¢«åˆ’åˆ†ä¸ºåˆ»åº¦ï¼šæ¯ä¸ªåˆ»åº¦å¯¹åº”ä¸€ä¸ªä»·æ ¼å¹¶æœ‰ä¸€ä¸ªç´¢å¼•ã€‚åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ± å®žçŽ°ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥æ¯1 ETH 5000ç¾Žå…ƒçš„ä»·æ ¼ç”¨USDCè´­ä¹°ETHã€‚è´­ä¹°ETHå°†ä»Žæ± ä¸­ç§»é™¤ä¸€å®šæ•°é‡çš„ETHï¼Œå¹¶å°†ä»·æ ¼ç•¥å¾®æŽ¨é«˜åˆ°5000ç¾Žå…ƒä»¥ä¸Šã€‚æˆ‘ä»¬å¸Œæœ›åœ¨åŒ…å«è¿™ä¸ªä»·æ ¼çš„èŒƒå›´å†…æä¾›æµåŠ¨æ€§ã€‚å¹¶ä¸”æˆ‘ä»¬å¸Œæœ›ç¡®ä¿æœ€ç»ˆä»·æ ¼ä¿æŒåœ¨**è¿™ä¸ªèŒƒå›´å†…**ï¼ˆæˆ‘ä»¬å°†åœ¨åŽé¢çš„é‡Œç¨‹ç¢‘ä¸­è¿›è¡Œå¤šèŒƒå›´äº¤æ¢ï¼‰ã€‚

æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸‰ä¸ªåˆ»åº¦ï¼š

1. å½“å‰åˆ»åº¦å°†å¯¹åº”å½“å‰ä»·æ ¼ï¼ˆ1 ETH = 5000 USDCï¼‰ã€‚

2. æˆ‘ä»¬æä¾›æµåŠ¨æ€§çš„ä»·æ ¼èŒƒå›´çš„ä¸Šä¸‹ç•Œã€‚è®©ä¸‹é™ä»·æ ¼ä¸º4545ç¾Žå…ƒï¼Œä¸Šé™ä»·æ ¼ä¸º5500ç¾Žå…ƒã€‚

ä»Žç†è®ºä»‹ç»ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š

$$\sqrt{P} = \sqrt{\frac{y}{x}}$$

ç”±äºŽæˆ‘ä»¬åŒæ„ä½¿ç”¨ETHä½œä¸º$x$å‚¨å¤‡ï¼ŒUSDCä½œä¸º$y$å‚¨å¤‡ï¼Œæ¯ä¸ªåˆ»åº¦çš„ä»·æ ¼ä¸ºï¼š

$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$

$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$

$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$

å…¶ä¸­$P_c$æ˜¯å½“å‰ä»·æ ¼ï¼Œ$P_l$æ˜¯èŒƒå›´çš„ä¸‹é™ï¼Œ$P_u$æ˜¯èŒƒå›´çš„ä¸Šé™ã€‚

çŽ°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„åˆ»åº¦ã€‚æˆ‘ä»¬çŸ¥é“ä»·æ ¼å’Œåˆ»åº¦é€šè¿‡ä»¥ä¸‹å…¬å¼ç›¸è¿žï¼š

$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°åˆ»åº¦$i$ï¼š

$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$

> è¿™ä¸ªå…¬å¼ä¸­çš„å¹³æ–¹æ ¹ç›¸äº’æŠµæ¶ˆï¼Œä½†ç”±äºŽæˆ‘ä»¬ä½¿ç”¨$\sqrt{p}$å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¿ç•™å®ƒä»¬ã€‚

è®©æˆ‘ä»¬æ‰¾åˆ°è¿™äº›åˆ»åº¦ï¼š

1. å½“å‰åˆ»åº¦ï¼š$i_c = log_{\sqrt{1.0001}} 70.71 = 85176$

2. ä¸‹é™åˆ»åº¦ï¼š$i_l = log_{\sqrt{1.0001}} 67.42 = 84222$

3. ä¸Šé™åˆ»åº¦ï¼š$i_u = log_{\sqrt{1.0001}} 74.16 = 86129$

> ä¸ºäº†è®¡ç®—è¿™äº›ï¼Œæˆ‘ä½¿ç”¨äº†Pythonï¼š

> ```python
> import math
>
> def price_to_tick(p):
>     return math.floor(math.log(p, 1.0001))
>
> price_to_tick(5000)
> > 85176
>```

è¿™å°±æ˜¯ä»·æ ¼èŒƒå›´è®¡ç®—çš„å…¨éƒ¨å†…å®¹ï¼

è¿™é‡Œéœ€è¦æ³¨æ„çš„æœ€åŽä¸€ç‚¹æ˜¯ï¼ŒUniswapä½¿ç”¨[Q64.96æ•°å­—](https://en.wikipedia.org/wiki/Q_%28number_format%29)æ¥å­˜å‚¨$\sqrt{P}$ã€‚è¿™æ˜¯ä¸€ä¸ªå®šç‚¹æ•°ï¼Œæ•´æ•°éƒ¨åˆ†æœ‰64ä½ï¼Œå°æ•°éƒ¨åˆ†æœ‰96ä½ã€‚åœ¨æˆ‘ä»¬ä¸Šé¢çš„è®¡ç®—ä¸­ï¼Œä»·æ ¼æ˜¯æµ®ç‚¹æ•°ï¼š`70.71`ã€`67.42`å’Œ`74.16`ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬æ¢ä¸ºQ64.96ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™å¾ˆç®€å•ï¼šæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ•°å­—ä¹˜ä»¥$2^{96}$ï¼ˆQæ•°æ˜¯äºŒè¿›åˆ¶å®šç‚¹æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„å°æ•°ä¹˜ä»¥Q64.96çš„åŸºæ•°ï¼Œå³$2^{96}$ï¼‰ã€‚æˆ‘ä»¬å°†å¾—åˆ°ï¼š

$$\sqrt{P_c} = 5602277097478614198912276234240$$

$$\sqrt{P_l} = 5314786713428871004159001755648$$

$$\sqrt{P_u} = 5875717789736564987741329162240$$

> åœ¨Pythonä¸­ï¼š

> ```python
> q96 = 2**96
> def price_to_sqrtp(p):
>     return int(math.sqrt(p) * q96)
>
> price_to_sqrtp(5000)
> > 5602277097478614198912276234240
> ```

> æ³¨æ„æˆ‘ä»¬åœ¨è½¬æ¢ä¸ºæ•´æ•°ä¹‹å‰è¿›è¡Œä¹˜æ³•ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å°†å¤±åŽ»ç²¾åº¦ã€‚

## ä»£å¸æ•°é‡è®¡ç®—

ä¸‹ä¸€æ­¥æ˜¯å†³å®šæˆ‘ä»¬æƒ³è¦å­˜å…¥æ± ä¸­çš„ä»£å¸æ•°é‡ã€‚ç­”æ¡ˆæ˜¯æˆ‘ä»¬æƒ³è¦å¤šå°‘å°±å¤šå°‘ã€‚è¿™äº›æ•°é‡å¹¶æ²¡æœ‰ä¸¥æ ¼å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å­˜å…¥è¶³å¤Ÿçš„æ•°é‡ï¼Œä»¥ä¾¿åœ¨ä¸ä½¿å½“å‰ä»·æ ¼ç¦»å¼€æˆ‘ä»¬æŠ•å…¥æµåŠ¨æ€§çš„ä»·æ ¼èŒƒå›´çš„æƒ…å†µä¸‹è´­ä¹°å°‘é‡ETHã€‚åœ¨å¼€å‘å’Œæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿé“¸é€ ä»»ä½•æ•°é‡çš„ä»£å¸ï¼Œæ‰€ä»¥èŽ·å¾—æˆ‘ä»¬æƒ³è¦çš„æ•°é‡ä¸æ˜¯é—®é¢˜ã€‚

å¯¹äºŽæˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡äº¤æ¢ï¼Œè®©æˆ‘ä»¬å­˜å…¥1 ETHå’Œ5000 USDCã€‚

> è¯·è®°ä½ï¼Œå½“å‰æ± å‚¨å¤‡çš„æ¯”ä¾‹è¡¨ç¤ºå½“å‰çŽ°è´§ä»·æ ¼ã€‚å› æ­¤ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³å‘æ± ä¸­æŠ•å…¥æ›´å¤šä»£å¸å¹¶ä¿æŒç›¸åŒçš„ä»·æ ¼ï¼Œæ•°é‡å¿…é¡»æˆæ¯”ä¾‹ï¼Œä¾‹å¦‚ï¼š2 ETHå’Œ10,000 USDCï¼›10 ETHå’Œ50,000 USDCç­‰ã€‚

## æµåŠ¨æ€§æ•°é‡è®¡ç®—

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æˆ‘ä»¬å°†å­˜å…¥çš„æ•°é‡è®¡ç®—$L$ã€‚è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥è¯·ä»”ç»†å¬ï¼

ä»Žç†è®ºä»‹ç»ä¸­ï¼Œä½ è®°å¾—ï¼š

$$L = \sqrt{xy}$$

ç„¶è€Œï¼Œè¿™ä¸ªå…¬å¼æ˜¯é’ˆå¯¹æ— é™æ›²çº¿çš„ðŸ™‚ ä½†æˆ‘ä»¬æƒ³è¦å°†æµåŠ¨æ€§æŠ•å…¥åˆ°æœ‰é™çš„ä»·æ ¼èŒƒå›´å†…ï¼Œè¿™åªæ˜¯é‚£ä¸ªæ— é™æ›²çº¿çš„ä¸€ä¸ªç‰‡æ®µã€‚æˆ‘ä»¬éœ€è¦ä¸“é—¨ä¸ºæˆ‘ä»¬è¦å­˜å…¥æµåŠ¨æ€§çš„ä»·æ ¼èŒƒå›´è®¡ç®—$L$ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›æ›´é«˜çº§çš„è®¡ç®—ã€‚

ä¸ºäº†è®¡ç®—ä»·æ ¼èŒƒå›´çš„$L$ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„æœ‰è¶£äº‹å®žï¼šä»·æ ¼èŒƒå›´å¯èƒ½ä¼šè€—å°½ã€‚å¯ä»¥ä»Žä»·æ ¼èŒƒå›´ä¸­ä¹°èµ°ä¸€ç§ä»£å¸çš„å…¨éƒ¨æ•°é‡ï¼Œä½¿æ± ä¸­åªå‰©ä¸‹å¦ä¸€ç§ä»£å¸ã€‚

![èŒƒå›´è€—å°½ç¤ºä¾‹](images/range_depleted.png)

åœ¨ç‚¹$a$å’Œ$b$ï¼ŒèŒƒå›´å†…åªæœ‰ä¸€ç§ä»£å¸ï¼šåœ¨ç‚¹$a$å¤„æ˜¯ETHï¼Œåœ¨ç‚¹$b$å¤„æ˜¯USDCã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æƒ³æ‰¾åˆ°ä¸€ä¸ª$L$ï¼Œä½¿ä»·æ ¼èƒ½å¤Ÿç§»åŠ¨åˆ°ä»»ä¸€ç‚¹ã€‚æˆ‘ä»¬å¸Œæœ›æœ‰è¶³å¤Ÿçš„æµåŠ¨æ€§è®©ä»·æ ¼è¾¾åˆ°ä»·æ ¼èŒƒå›´çš„ä»»ä¸€è¾¹ç•Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›$L$åŸºäºŽ$\Delta x$å’Œ$\Delta y$çš„æœ€å¤§æ•°é‡æ¥è®¡ç®—ã€‚

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¾¹ç¼˜å¤„çš„ä»·æ ¼æ˜¯å¤šå°‘ã€‚å½“ä»Žæ± ä¸­ä¹°å…¥ETHæ—¶ï¼Œä»·æ ¼ä¸Šæ¶¨ï¼›å½“ä¹°å…¥USDCæ—¶ï¼Œä»·æ ¼ä¸‹è·Œã€‚å›žæƒ³ä¸€ä¸‹ï¼Œä»·æ ¼æ˜¯$\frac{y}{x}$ã€‚æ‰€ä»¥ï¼Œåœ¨ç‚¹$a$ï¼Œä»·æ ¼æ˜¯èŒƒå›´å†…çš„æœ€ä½Žç‚¹ï¼›åœ¨ç‚¹$b$ï¼Œä»·æ ¼æ˜¯æœ€é«˜ç‚¹ã€‚

>å®žé™…ä¸Šï¼Œåœ¨è¿™äº›ç‚¹ä¸Šä»·æ ¼å¹¶æ²¡æœ‰å®šä¹‰ï¼Œå› ä¸ºæ± ä¸­åªæœ‰ä¸€ç§å‚¨å¤‡ï¼Œä½†æˆ‘ä»¬éœ€è¦ç†è§£çš„æ˜¯ï¼Œç‚¹$b$é™„è¿‘çš„ä»·æ ¼é«˜äºŽèµ·å§‹ä»·æ ¼ï¼Œè€Œç‚¹$a$å¤„çš„ä»·æ ¼ä½ŽäºŽèµ·å§‹ä»·æ ¼ã€‚

çŽ°åœ¨ï¼Œå°†ä¸Šå›¾ä¸­çš„æ›²çº¿åˆ†æˆä¸¤æ®µï¼šä¸€æ®µåœ¨èµ·å§‹ç‚¹çš„å·¦ä¾§ï¼Œä¸€æ®µåœ¨èµ·å§‹ç‚¹çš„å³ä¾§ã€‚æˆ‘ä»¬å°†è®¡ç®—**ä¸¤ä¸ª**$L$ï¼Œæ¯æ®µä¸€ä¸ªã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ± ä¸­çš„ä¸¤ç§ä»£å¸å„è‡ªè´¡çŒ®äº†**å…¶ä¸­ä¸€æ®µ**ï¼šå·¦æ®µå®Œå…¨ç”±ä»£å¸$x$ç»„æˆï¼Œå³æ®µå®Œå…¨ç”±ä»£å¸$y$ç»„æˆã€‚è¿™æºäºŽåœ¨äº¤æ¢è¿‡ç¨‹ä¸­ï¼Œä»·æ ¼å‘ä»»ä¸€æ–¹å‘ç§»åŠ¨çš„äº‹å®žï¼šå®ƒè¦ä¹ˆä¸Šæ¶¨ï¼Œè¦ä¹ˆä¸‹è·Œã€‚ä¸ºäº†ä½¿ä»·æ ¼ç§»åŠ¨ï¼Œåªéœ€è¦å…¶ä¸­ä¸€ç§ä»£å¸ï¼š

1. å½“ä»·æ ¼ä¸Šæ¶¨æ—¶ï¼Œåªéœ€è¦ä»£å¸$x$è¿›è¡Œäº¤æ¢ï¼ˆæˆ‘ä»¬æ­£åœ¨ä¹°å…¥ä»£å¸$x$ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæƒ³ä»Žæ± ä¸­å–å‡ºä»£å¸$x$ï¼‰ï¼›

2. å½“ä»·æ ¼ä¸‹è·Œæ—¶ï¼Œåªéœ€è¦ä»£å¸$y$è¿›è¡Œäº¤æ¢ã€‚

å› æ­¤ï¼Œå½“å‰ä»·æ ¼å·¦ä¾§æ›²çº¿æ®µçš„æµåŠ¨æ€§ä»…ç”±ä»£å¸$x$ç»„æˆï¼Œå¹¶ä¸”ä»…æ ¹æ®æä¾›çš„ä»£å¸$x$æ•°é‡è®¡ç®—ã€‚åŒæ ·ï¼Œå½“å‰ä»·æ ¼å³ä¾§æ›²çº¿æ®µçš„æµåŠ¨æ€§ä»…ç”±ä»£å¸$y$ç»„æˆï¼Œå¹¶ä¸”ä»…æ ¹æ®æä¾›çš„ä»£å¸$y$æ•°é‡è®¡ç®—ã€‚

![æ›²çº¿ä¸Šçš„æµåŠ¨æ€§](images/curve_liquidity.png)

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æä¾›æµåŠ¨æ€§æ—¶ï¼Œæˆ‘ä»¬è®¡ç®—ä¸¤ä¸ª$L$å¹¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚é€‰æ‹©å“ªä¸€ä¸ªï¼Ÿè¾ƒå°çš„é‚£ä¸ªã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¾ƒå¤§çš„é‚£ä¸ªå·²ç»åŒ…å«äº†è¾ƒå°çš„é‚£ä¸ªï¼æˆ‘ä»¬å¸Œæœ›æ–°çš„æµåŠ¨æ€§**å‡åŒ€**åˆ†å¸ƒåœ¨æ›²çº¿ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›åœ¨å½“å‰ä»·æ ¼çš„å·¦å³ä¸¤ä¾§æ·»åŠ ç›¸åŒçš„$L$ã€‚å¦‚æžœæˆ‘ä»¬é€‰æ‹©è¾ƒå¤§çš„é‚£ä¸ªï¼Œç”¨æˆ·éœ€è¦æä¾›æ›´å¤šçš„æµåŠ¨æ€§æ¥è¡¥å¿è¾ƒå°çš„é‚£ä¸ªçš„ä¸è¶³ã€‚å½“ç„¶ï¼Œè¿™æ˜¯å¯è¡Œçš„ï¼Œä½†è¿™ä¼šä½¿æ™ºèƒ½åˆçº¦å˜å¾—æ›´å¤æ‚ã€‚

> è¾ƒå¤§çš„$L$çš„å‰©ä½™éƒ¨åˆ†ä¼šæ€Žæ ·ï¼Ÿå—¯ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚åœ¨é€‰æ‹©è¾ƒå°çš„$L$ä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å…¶è½¬æ¢ä¸ºå¯¼è‡´è¾ƒå¤§$L$çš„ä»£å¸çš„è¾ƒå°æ•°é‡â€”â€”è¿™å°†è°ƒæ•´å®ƒã€‚ä¹‹åŽï¼Œæˆ‘ä»¬å°†å¾—åˆ°èƒ½äº§ç”Ÿç›¸åŒ$L$çš„ä»£å¸æ•°é‡ã€‚

è¿™é‡Œæˆ‘éœ€è¦ä½ æ³¨æ„çš„æœ€åŽä¸€ä¸ªç»†èŠ‚æ˜¯ï¼š**æ–°çš„æµåŠ¨æ€§ä¸èƒ½æ”¹å˜å½“å‰ä»·æ ¼**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¿…é¡»ä¸Žå½“å‰å‚¨å¤‡çš„æ¯”ä¾‹æˆæ¯”ä¾‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ª$L$å¯èƒ½ä¸åŒâ€”â€”å½“æ¯”ä¾‹æ²¡æœ‰ä¿æŒæ—¶ã€‚æˆ‘ä»¬é€‰æ‹©è¾ƒå°çš„$L$æ¥é‡æ–°å»ºç«‹æ¯”ä¾‹ã€‚

æˆ‘å¸Œæœ›åœ¨æˆ‘ä»¬ç”¨ä»£ç å®žçŽ°è¿™ä¸ªä¹‹åŽï¼Œè¿™ä¼šæ›´æœ‰æ„ä¹‰ï¼çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…¬å¼ã€‚

è®©æˆ‘ä»¬å›žé¡¾ä¸€ä¸‹$\Delta x$å’Œ$\Delta y$æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼š

$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$

$$\Delta y = \Delta \sqrt{P} L$$

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨å®žé™…ä»·æ ¼æ›¿æ¢delta Pæ¥æ‰©å±•è¿™äº›å…¬å¼ï¼ˆæˆ‘ä»¬ä»Žä¸Šé¢çŸ¥é“å®ƒä»¬ï¼‰ï¼š

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$

$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$

$P_a$æ˜¯ç‚¹$a$å¤„çš„ä»·æ ¼ï¼Œ$P_b$æ˜¯ç‚¹$b$å¤„çš„ä»·æ ¼ï¼Œ$P_c$æ˜¯å½“å‰ä»·æ ¼ï¼ˆè§ä¸Šå›¾ï¼‰ã€‚æ³¨æ„ï¼Œç”±äºŽä»·æ ¼è®¡ç®—ä¸º$\frac{y}{x}$ï¼ˆå³å®ƒæ˜¯ä»¥$y$è¡¨ç¤ºçš„$x$çš„ä»·æ ¼ï¼‰ï¼Œç‚¹$b$å¤„çš„ä»·æ ¼é«˜äºŽå½“å‰ä»·æ ¼å’Œç‚¹$a$å¤„çš„ä»·æ ¼ã€‚ç‚¹$a$å¤„çš„ä»·æ ¼æ˜¯ä¸‰è€…ä¸­æœ€ä½Žçš„ã€‚

è®©æˆ‘ä»¬ä»Žç¬¬ä¸€ä¸ªå…¬å¼ä¸­æ‰¾åˆ°$L$ï¼š

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$

$$\Delta x = \frac{L}{\sqrt{P_c}} - \frac{L}{\sqrt{P_b}}$$

$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$

$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$

ä»Žç¬¬äºŒä¸ªå…¬å¼ï¼š

$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$

$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

æ‰€ä»¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ä¸¤ä¸ª$L$ï¼Œæ¯ä¸ªæ®µä¸€ä¸ªï¼š

$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$

$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬å°†æˆ‘ä»¬ä¹‹å‰è®¡ç®—çš„ä»·æ ¼ä»£å…¥å®ƒä»¬ï¼š

$$L = \Delta x \frac{\sqrt{P_b}\sqrt{P_c}}{\sqrt{P_b}-\sqrt{P_c}} = 1 ETH * \frac{5875... * 5602...}{5875... - 5602...}$$

è½¬æ¢ä¸ºQ64.96åŽï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š

$$L = 1519437308014769733632$$

å¯¹äºŽå¦ä¸€ä¸ª$L$ï¼š

$$L = \frac{\Delta y}{\sqrt{P_c}-\sqrt{P_a}} = \frac{5000USDC}{5602... - 5314...}$$

$$L = 1517882343751509868544$$

åœ¨è¿™ä¸¤ä¸ªä¸­ï¼Œæˆ‘ä»¬å°†é€‰æ‹©è¾ƒå°çš„é‚£ä¸ªã€‚

> åœ¨Pythonä¸­ï¼š

> ```python
> sqrtp_low = price_to_sqrtp(4545)
> sqrtp_cur = price_to_sqrtp(5000)
> sqrtp_upp = price_to_sqrtp(5500)
> 
> def liquidity0(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return (amount * (pa * pb) / q96) / (pb - pa)
>
> def liquidity1(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return amount * q96 / (pb - pa)
>
> eth = 10**18
> amount_eth = 1 * eth
> amount_usdc = 5000 * eth
> 
> liq0 = liquidity0(amount_eth, sqrtp_cur, sqrtp_upp)
> liq1 = liquidity1(amount_usdc, sqrtp_cur, sqrtp_low)
> liq = int(min(liq0, liq1))
> > 1517882343751509868544
> ```

## å†æ¬¡è®¡ç®—ä»£å¸æ•°é‡

ç”±äºŽæˆ‘ä»¬é€‰æ‹©äº†è¦å­˜å…¥çš„æ•°é‡ï¼Œè¿™äº›æ•°é‡å¯èƒ½æ˜¯é”™è¯¯çš„ã€‚æˆ‘ä»¬ä¸èƒ½åœ¨ä»»ä½•ä»·æ ¼èŒƒå›´å†…å­˜å…¥ä»»ä½•æ•°é‡ï¼›æµåŠ¨æ€§æ•°é‡éœ€è¦å‡åŒ€åˆ†å¸ƒåœ¨æˆ‘ä»¬å­˜å…¥çš„ä»·æ ¼èŒƒå›´çš„æ›²çº¿ä¸Šã€‚å› æ­¤ï¼Œå³ä½¿ç”¨æˆ·é€‰æ‹©äº†æ•°é‡ï¼Œåˆçº¦ä¹Ÿéœ€è¦é‡æ–°è®¡ç®—å®ƒä»¬ï¼Œå®žé™…æ•°é‡ä¼šç•¥æœ‰ä¸åŒï¼ˆè‡³å°‘æ˜¯å› ä¸ºå››èˆäº”å…¥ï¼‰ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å…¬å¼ï¼š

$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$

$$\Delta y = L(\sqrt{P_c} - \sqrt{P_a})$$

> åœ¨Pythonä¸­ï¼š

> ```python
> def calc_amount0(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * q96 * (pb - pa) / pa / pb)
> 
> 
> def calc_amount1(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * (pb - pa) / q96)
>
> amount0 = calc_amount0(liq, sqrtp_upp, sqrtp_cur)
> amount1 = calc_amount1(liq, sqrtp_low, sqrtp_cur)
> (amount0, amount1)
> > (998976618347425408, 5000000000000000000000)
> ```

> å¦‚ä½ æ‰€è§ï¼Œè¿™äº›æ•°å­—æŽ¥è¿‘æˆ‘ä»¬æƒ³è¦æä¾›çš„æ•°é‡ï¼Œä½†ETHç•¥å°ã€‚

> **æç¤º**ï¼šä½¿ç”¨`cast --from-wei AMOUNT`å°†weiè½¬æ¢ä¸ºetherï¼Œä¾‹å¦‚ï¼š
> `cast --from-wei 998976618347425280`å°†ç»™ä½ `0.998976618347425280`ã€‚



