<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>部署 - Uniswap V3 Development Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A book that teaches how to build a clone of Uniswap V3 in Solidity from scratch.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Uniswap V3 开发手册</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 0. 背景</li><li class="chapter-item expanded "><a href="../milestone_0/introduction-to-markets.html"><strong aria-hidden="true">1.</strong> 市场介绍</a></li><li class="chapter-item expanded "><a href="../milestone_0/constant-function-market-maker.html"><strong aria-hidden="true">2.</strong> 恒定函数做市商</a></li><li class="chapter-item expanded "><a href="../milestone_0/uniswap-v3.html"><strong aria-hidden="true">3.</strong> Uniswap V3</a></li><li class="chapter-item expanded "><a href="../milestone_0/dev-environment.html"><strong aria-hidden="true">4.</strong> 开发环境</a></li><li class="chapter-item expanded "><a href="../milestone_0/what-we-will-build.html"><strong aria-hidden="true">5.</strong> 我们将要构建什么</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 1. 第一次交换</li><li class="chapter-item expanded "><a href="../milestone_1/introduction.html"><strong aria-hidden="true">6.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_1/calculating-liquidity.html"><strong aria-hidden="true">7.</strong> 计算流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/providing-liquidity.html"><strong aria-hidden="true">8.</strong> 提供流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/first-swap.html"><strong aria-hidden="true">9.</strong> 第一次交换</a></li><li class="chapter-item expanded "><a href="../milestone_1/manager-contract.html"><strong aria-hidden="true">10.</strong> 管理合约</a></li><li class="chapter-item expanded "><a href="../milestone_1/deployment.html" class="active"><strong aria-hidden="true">11.</strong> 部署</a></li><li class="chapter-item expanded "><a href="../milestone_1/user-interface.html"><strong aria-hidden="true">12.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 2. 第二次交换</li><li class="chapter-item expanded "><a href="../milestone_2/introduction.html"><strong aria-hidden="true">13.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_2/output-amount-calculation.html"><strong aria-hidden="true">14.</strong> 输出金额计算</a></li><li class="chapter-item expanded "><a href="../milestone_2/math-in-solidity.html"><strong aria-hidden="true">15.</strong> Solidity中的数学运算</a></li><li class="chapter-item expanded "><a href="../milestone_2/tick-bitmap-index.html"><strong aria-hidden="true">16.</strong> Tick位图索引</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-minting.html"><strong aria-hidden="true">17.</strong> 通用铸造</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-swapping.html"><strong aria-hidden="true">18.</strong> 通用交换</a></li><li class="chapter-item expanded "><a href="../milestone_2/quoter-contract.html"><strong aria-hidden="true">19.</strong> 报价合约</a></li><li class="chapter-item expanded "><a href="../milestone_2/user-interface.html"><strong aria-hidden="true">20.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 3. 跨Tick交换</li><li class="chapter-item expanded "><a href="../milestone_3/introduction.html"><strong aria-hidden="true">21.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_3/different-ranges.html"><strong aria-hidden="true">22.</strong> 不同价格范围</a></li><li class="chapter-item expanded "><a href="../milestone_3/cross-tick-swaps.html"><strong aria-hidden="true">23.</strong> Cross-Tick 交换</a></li><li class="chapter-item expanded "><a href="../milestone_3/slippage-protection.html"><strong aria-hidden="true">24.</strong> 滑点保护</a></li><li class="chapter-item expanded "><a href="../milestone_3/liquidity-calculation.html"><strong aria-hidden="true">25.</strong> 流动性计算</a></li><li class="chapter-item expanded "><a href="../milestone_3/more-on-fixed-point-numbers.html"><strong aria-hidden="true">26.</strong> 关于定点数的更多内容</a></li><li class="chapter-item expanded "><a href="../milestone_3/flash-loans.html"><strong aria-hidden="true">27.</strong> 闪电贷</a></li><li class="chapter-item expanded "><a href="../milestone_3/user-interface.html"><strong aria-hidden="true">28.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 4. 多池交换</li><li class="chapter-item expanded "><a href="../milestone_4/introduction.html"><strong aria-hidden="true">29.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_4/factory-contract.html"><strong aria-hidden="true">30.</strong> 工厂合约</a></li><li class="chapter-item expanded "><a href="../milestone_4/path.html"><strong aria-hidden="true">31.</strong> 交换路径</a></li><li class="chapter-item expanded "><a href="../milestone_4/multi-pool-swaps.html"><strong aria-hidden="true">32.</strong> 多池交换</a></li><li class="chapter-item expanded "><a href="../milestone_4/user-interface.html"><strong aria-hidden="true">33.</strong> 用户界面</a></li><li class="chapter-item expanded "><a href="../milestone_4/tick-rounding.html"><strong aria-hidden="true">34.</strong> Tick舍入</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 5. 费用和价格预言机</li><li class="chapter-item expanded "><a href="../milestone_5/introduction.html"><strong aria-hidden="true">35.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_5/swap-fees.html"><strong aria-hidden="true">36.</strong> 交换费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/flash-loan-fees.html"><strong aria-hidden="true">37.</strong> 闪电贷费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/protocol-fees.html"><strong aria-hidden="true">38.</strong> 协议费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/price-oracle.html"><strong aria-hidden="true">39.</strong> 价格预言机</a></li><li class="chapter-item expanded "><a href="../milestone_5/user-interface.html"><strong aria-hidden="true">40.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 6: NFT 头寸</li><li class="chapter-item expanded "><a href="../milestone_6/introduction.html"><strong aria-hidden="true">41.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_6/erc721-overview.html"><strong aria-hidden="true">42.</strong> ERC721概述</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-manager.html"><strong aria-hidden="true">43.</strong> NFT管理器</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-renderer.html"><strong aria-hidden="true">44.</strong> NFT渲染器</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Uniswap V3 Development Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book/edit/main/src/milestone_1/deployment.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="deployment"><a class="header" href="#deployment">Deployment</a></h1>
<p>Alright, our pool contract is done. Now, let’s see how we can deploy it to a local Ethereum network so we can use it from a front-end app later on.</p>
<h2 id="choosing-local-blockchain-network"><a class="header" href="#choosing-local-blockchain-network">Choosing Local Blockchain Network</a></h2>
<p>Smart contracts development requires running a local network, where you deploy your contracts during development and testing. This is what we want from such a network:</p>
<ol>
<li>Real blockchain. It must be a real Ethereum network, not an emulation. We want to be sure that our contract will work in the local network exactly as it would in the mainnet.</li>
<li>Speed. We want our transactions to be minted immediately, so we can iterate quickly.</li>
<li>Ether. To pay transaction fees, we need some ether, and we want the local network to allow us to generate any amount of ether.</li>
<li>Cheat codes. Besides providing the standard API, we want a local network to allow us to do more. For example, we want to be able to deploy contracts at any address, execute transactions from any address (impersonate other address), change contract state directly, etc.</li>
</ol>
<p>There are multiple solutions as of today:</p>
<ol>
<li><a href="https://trufflesuite.com/ganache/">Ganache</a> from Truffle Suite.</li>
<li><a href="https://hardhat.org/">Hardhat</a>, which is a development environment that includes a local node besides other useful things.</li>
<li><a href="https://github.com/foundry-rs/foundry/tree/master/anvil">Anvil</a> from Foundry.</li>
</ol>
<p>All of these are viable solutions and each of them will satisfy our needs. Having said that, projects have been slowly migrating from Ganache (which is the oldest of the solutions) to Hardhat (which seems to be the most widely used these days), and now there’s the new kid on the block: Foundry. Foundry is also the only one of these solutions that uses Solidity for writing tests (the others use JavaScript). Moreover, Foundry also allows to write deployment scripts in Solidity.  Thus, since we’ve decided to use Solidity everywhere, we’ll use Anvil to run a local development blockchain, and we’ll write deployment scripts in Solidity.</p>
<h2 id="running-local-blockchain"><a class="header" href="#running-local-blockchain">Running Local Blockchain</a></h2>
<p>Anvil doesn’t require configuration, we can run it with a single command and it’ll do:</p>
<pre><code class="language-shell">$ anvil --code-size-limit 50000
                             _   _
                            (_) | |
      __ _   _ __   __   __  _  | |
     / _` | | '_ \  \ \ / / | | | |
    | (_| | | | | |  \ V /  | | | |
     \__,_| |_| |_|   \_/   |_| |_|

    0.1.0 (d89f6af 2022-06-24T00:15:17.897682Z)
    https://github.com/foundry-rs/foundry
...
Listening on 127.0.0.1:8545
</code></pre>
<blockquote>
<p>We’re going to write big contracts that don’t fit into the Ethereum contract size limit (which is <code>24576</code> bytes), thus we need to tell Anvil to allow bigger smart contracts.</p>
</blockquote>
<p>Anvil runs a single Ethereum node, so this is not a network, but that’s ok. By default, it creates 10 accounts with 10,000 ETH in each of them. It prints the addresses and related private keys when it starts–we’ll be using one of these addresses when deploying and interacting with the contract from UI.</p>
<p>Anvil exposes the JSON-RPC API interface at <code>127.0.0.1:8545</code>–this interface is the main way of interacting with Ethereum nodes. You can find the full API reference <a href="https://ethereum.org/en/developers/docs/apis/json-rpc/">here</a>. And this is how you can call it via <code>curl</code>:</p>
<pre><code class="language-shell">$ curl -X POST -H 'Content-Type: application/json' \
  --data '{&quot;id&quot;:1,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_chainId&quot;}' \
  http://127.0.0.1:8545
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:&quot;0x7a69&quot;}
$ curl -X POST -H 'Content-Type: application/json' \
  --data '{&quot;id&quot;:1,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_getBalance&quot;,&quot;params&quot;:[&quot;0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266&quot;,&quot;latest&quot;]}' \
  http://127.0.0.1:8545
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:&quot;0x21e19e0c9bab2400000&quot;}
</code></pre>
<p>You can also use <code>cast</code> (part of Foundry) for that:</p>
<pre><code class="language-shell">$ cast chain-id
31337
$ cast balance 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
10000000000000000000000
</code></pre>
<p>Now, let’s deploy the pool and manager contracts to the local network.</p>
<h2 id="first-deployment"><a class="header" href="#first-deployment">First Deployment</a></h2>
<p>At its core, deploying a contract means:</p>
<ol>
<li>Compiling source code into EVM bytecode.</li>
<li>Sending a transaction with the bytecode.</li>
<li>Creating a new address, executing the constructor part of the bytecode, and storing deployed bytecode on the address. This step is done automatically by an Ethereum node when your contract creation transaction is mined.</li>
</ol>
<p>Deployment usually consists of multiple steps: preparing parameters, deploying auxiliary contracts, deploying main contracts, initializing contracts, etc. Scripting helps to automate these steps, and we’ll write scripts in Solidity!</p>
<p>Create <code>scripts/DeployDevelopment.sol</code> contract with this content:</p>
<pre><code class="language-solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.14;

import &quot;forge-std/Script.sol&quot;;

contract DeployDevelopment is Script {
    function run() public {
      ...
    }
}
</code></pre>
<p>It looks very similar to the test contract, with only difference is that it inherits from the <code>Script</code> contract, not from <code>Test</code>. And, by convention, we need to define the <code>run</code> function which will be the body of our deployment script. In the <code>run</code> function, we define the parameters of the deployment first:</p>
<pre><code class="language-solidity">uint256 wethBalance = 1 ether;
uint256 usdcBalance = 5042 ether;
int24 currentTick = 85176;
uint160 currentSqrtP = 5602277097478614198912276234240;
</code></pre>
<p>These are the same values we used before. Notice that we’re about to mint 5042 USDC–that’s 5000 USDC we’ll provide as liquidity into the pool and 42 USDC we’ll sell in a swap.</p>
<p>Next, we define the set of steps that will be executed as the deployment transaction (well, each of the steps will be a separate transaction). For this, we’re using <code>startBroadcast/endBroadcast</code> cheat codes:</p>
<pre><code class="language-solidity">vm.startBroadcast();
...
vm.stopBroadcast();
</code></pre>
<blockquote>
<p>These cheat codes are <a href="https://github.com/foundry-rs/foundry/tree/master/forge#cheat-codes">provided by Foundry</a>.  We got them in the script contract by inheriting from <code>forge-std/Script.sol</code>.</p>
</blockquote>
<p>Everything that goes after the <code>broadcast()</code> cheat code or between <code>startBroadcast()/stopBroadcast()</code> is converted to transactions and these transactions are sent to the node that executes the script.</p>
<p>Between the broadcast cheat codes, we’ll put the actual deployment steps. First, we need to deploy the tokens:</p>
<pre><code class="language-solidity">ERC20Mintable token0 = new ERC20Mintable(&quot;Wrapped Ether&quot;, &quot;WETH&quot;, 18);
ERC20Mintable token1 = new ERC20Mintable(&quot;USD Coin&quot;, &quot;USDC&quot;, 18);
</code></pre>
<p>We cannot deploy the pool without having tokens, so we need to deploy them first.</p>
<blockquote>
<p>Since we’re deploying to a local development network, we need to deploy the tokens ourselves. In the mainnet and public test networks (Ropsten, Goerli, Sepolia), the tokens are already created. Thus, to deploy to those networks, we’ll need to write network-specific deployment scripts.</p>
</blockquote>
<p>The next step is to deploy the pool contract:</p>
<pre><code class="language-solidity">UniswapV3Pool pool = new UniswapV3Pool(
    address(token0),
    address(token1),
    currentSqrtP,
    currentTick
);
</code></pre>
<p>Next goes Manager contract deployment:</p>
<pre><code class="language-solidity">UniswapV3Manager manager = new UniswapV3Manager();
</code></pre>
<p>And finally, we can mint some amount of ETH and USDC to our address:</p>
<pre><code class="language-solidity">token0.mint(msg.sender, wethBalance);
token1.mint(msg.sender, usdcBalance);
</code></pre>
<blockquote>
<p><code>msg.sender</code> in Foundry scripts is the address that sends transactions within the <code>broadcast</code> block. We’ll be able to set it when running scripts.</p>
</blockquote>
<p>Finally, at the end of the script, add some <code>console.log</code> calls to print the addresses of deployed contracts:</p>
<pre><code class="language-solidity">console.log(&quot;WETH address&quot;, address(token0));
console.log(&quot;USDC address&quot;, address(token1));
console.log(&quot;Pool address&quot;, address(pool));
console.log(&quot;Manager address&quot;, address(manager));
</code></pre>
<p>Alright, let’s run the script (ensure Anvil is running in another terminal window):</p>
<pre><code class="language-shell">$ forge script scripts/DeployDevelopment.s.sol --broadcast --fork-url http://localhost:8545 --private-key $PRIVATE_KEY  --code-size-limit 50000
</code></pre>
<blockquote>
<p>We’re increasing the smart contract code size again so that the compiler doesn’t fail.</p>
</blockquote>
<p><code>--broadcast</code> enables the broadcasting of transactions. It’s not enabled by default because not every script sends transactions. <code>--fork-url</code> sets the address of the node to send transactions to. <code>--private-key</code> sets the sender wallet: a private key is needed to sign transactions. You can pick any of the private keys printed by Anvil when it’s starting. I took the first one:</p>
<blockquote>
<p>0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80</p>
</blockquote>
<p>Deployment takes several seconds. In the end, you’ll see a list of transactions it sent. It’ll also save transaction receipts to the <code>broadcast</code> folder. In Anvil, you’ll also see many lines with <code>eth_sendRawTransaction</code>, <code>eth_getTransactionByHash</code>, and <code>eth_getTransactionReceipt</code>–after sending transactions to Anvil, Forge uses the JSON-RPC API to check their status and get transaction execution results (receipts).</p>
<p>Congratulations! You’ve just deployed a smart contract!</p>
<h2 id="interacting-with-contracts-abi"><a class="header" href="#interacting-with-contracts-abi">Interacting With Contracts, ABI</a></h2>
<p>Now, let’s see how we can interact with the deployed contracts.</p>
<p>Every contract exposes a set of public functions. In the case of the pool contract, these are <code>mint(...)</code> and <code>swap(...)</code>.  Additionally, Solidity creates getters for public variables, so we can also call <code>token0()</code>, <code>token1()</code>, <code>positions()</code>, etc.  However, since contracts are compiled bytecodes, <strong>function names are lost during compilation and not stored on blockchain</strong>. Instead, every function is identified by a selector, which is the first 4 bytes of the hash of the signature of the function. In pseudocode:</p>
<pre><code>hash(&quot;transfer(address,address,uint256)&quot;)[0:4]
</code></pre>
<blockquote>
<p>EVM uses <a href="https://en.wikipedia.org/wiki/SHA-3">the Keccak hashing algorithm</a>, which was standardized as SHA-3.  Specifically, the hashing function in Solidity is <code>keccak256</code>.</p>
</blockquote>
<p>Knowing this, let’s make two calls to the deployed contracts: one will be a low-level call via <code>curl</code>, and one will be made using <code>cast</code>.</p>
<h3 id="token-balance"><a class="header" href="#token-balance">Token Balance</a></h3>
<p>Let’s check the WETH balance of the deployer address. The signature of the function is <code>balanceOf(address)</code> (as defined in <a href="https://eips.ethereum.org/EIPS/eip-20">ERC-20</a>). To find the ID of this function (its selector), we’ll hash it and take the first four bytes:</p>
<pre><code class="language-shell">$ cast keccak &quot;balanceOf(address)&quot;| cut -b 1-10
0x70a08231
</code></pre>
<p>To pass the address, we simply append it to the function selector (and add left padding up to 32 digits since addresses take 32 bytes in function call data):</p>
<blockquote>
<p>0x70a08231000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266</p>
</blockquote>
<p><code>0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266</code> is the address we’re going to check the balance of. This is our address, the first account in Anvil.</p>
<p>Next, we execute the <code>eth_call</code> JSON-RPC method to make the call. Notice that this doesn’t require sending a transaction–this endpoint is used to read data from contracts.</p>
<pre><code class="language-shell">$ params='{&quot;from&quot;:&quot;0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266&quot;,&quot;to&quot;:&quot;0xe7f1725e7734ce288f8367e1bb143e90bb3f0512&quot;,&quot;data&quot;:&quot;0x70a08231000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266&quot;}'
$ curl -X POST -H 'Content-Type: application/json' \
  --data '{&quot;id&quot;:1,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_call&quot;,&quot;params&quot;:['&quot;$params&quot;',&quot;latest&quot;]}' \
  http://127.0.0.1:8545
{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:&quot;0x00000000000000000000000000000000000000000000011153ce5e56cf880000&quot;}
</code></pre>
<blockquote>
<p>The “to” address is the USDC token. It’s printed by the deployment script and it can be different in your case.</p>
</blockquote>
<p>Ethereum nodes return results as raw bytes, to parse them we need to know the type of a returned value. In the case of the <code>balanceOf</code> function, the type of a returned value is <code>uint256</code>. Using <code>cast</code>, we can convert it to a decimal number and then convert it to ether:</p>
<pre><code class="language-shell">$ cast --to-dec 0x00000000000000000000000000000000000000000000011153ce5e56cf880000| cast --from-wei
5042.000000000000000000
</code></pre>
<p>The balance is correct! We minted 5042 USDC to our address.</p>
<h3 id="current-tick-and-price"><a class="header" href="#current-tick-and-price">Current Tick and Price</a></h3>
<p>The above example is a demonstration of low-level contract calls. Usually, you never do calls via <code>curl</code> and use a tool or library that makes it easier. And Cast can help us here again!</p>
<p>Let’s get the current price and tick of a pool using <code>cast</code>:</p>
<pre><code class="language-shell">$ cast call POOL_ADDRESS &quot;slot0()&quot;| xargs cast --abi-decode &quot;a()(uint160,int24)&quot;
5602277097478614198912276234240
85176
</code></pre>
<p>Nice! The first value is the current <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1133em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9267em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-2.8867em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1133em;"><span></span></span></span></span></span></span></span></span> and the second value is the current tick.</p>
<blockquote>
<p>Since <code>--abi-decode</code> requires a full function signature we have to specify “a()” even though we only want to decode function output.</p>
</blockquote>
<h3 id="abi"><a class="header" href="#abi">ABI</a></h3>
<p>To simplify interaction with contracts, the Solidity compiler can output ABI, Application Binary Interface.</p>
<p>ABI is a JSON file that contains the description of all public methods and events of a contract. The goal of this file is to make it easier to encode function parameters and decode return values. To get ABI with Forge, use this command:</p>
<pre><code class="language-shell">$ forge inspect UniswapV3Pool abi
</code></pre>
<p>Feel free to skim through the file to better understand its content.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../milestone_1/manager-contract.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../milestone_1/user-interface.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../milestone_1/manager-contract.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../milestone_1/user-interface.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
