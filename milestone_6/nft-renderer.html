<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NFT渲染器 - Uniswap V3 Development Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A book that teaches how to build a clone of Uniswap V3 in Solidity from scratch.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Uniswap V3 开发手册</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 0. 背景</li><li class="chapter-item expanded "><a href="../milestone_0/introduction-to-markets.html"><strong aria-hidden="true">1.</strong> 市场介绍</a></li><li class="chapter-item expanded "><a href="../milestone_0/constant-function-market-maker.html"><strong aria-hidden="true">2.</strong> 恒定函数做市商</a></li><li class="chapter-item expanded "><a href="../milestone_0/uniswap-v3.html"><strong aria-hidden="true">3.</strong> Uniswap V3</a></li><li class="chapter-item expanded "><a href="../milestone_0/dev-environment.html"><strong aria-hidden="true">4.</strong> 开发环境</a></li><li class="chapter-item expanded "><a href="../milestone_0/what-we-will-build.html"><strong aria-hidden="true">5.</strong> 我们将要构建什么</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 1. 第一次交换</li><li class="chapter-item expanded "><a href="../milestone_1/introduction.html"><strong aria-hidden="true">6.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_1/calculating-liquidity.html"><strong aria-hidden="true">7.</strong> 计算流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/providing-liquidity.html"><strong aria-hidden="true">8.</strong> 提供流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/first-swap.html"><strong aria-hidden="true">9.</strong> 第一次交换</a></li><li class="chapter-item expanded "><a href="../milestone_1/manager-contract.html"><strong aria-hidden="true">10.</strong> 管理合约</a></li><li class="chapter-item expanded "><a href="../milestone_1/deployment.html"><strong aria-hidden="true">11.</strong> 部署</a></li><li class="chapter-item expanded "><a href="../milestone_1/user-interface.html"><strong aria-hidden="true">12.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 2. 第二次交换</li><li class="chapter-item expanded "><a href="../milestone_2/introduction.html"><strong aria-hidden="true">13.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_2/output-amount-calculation.html"><strong aria-hidden="true">14.</strong> 输出金额计算</a></li><li class="chapter-item expanded "><a href="../milestone_2/math-in-solidity.html"><strong aria-hidden="true">15.</strong> Solidity中的数学运算</a></li><li class="chapter-item expanded "><a href="../milestone_2/tick-bitmap-index.html"><strong aria-hidden="true">16.</strong> Tick位图索引</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-minting.html"><strong aria-hidden="true">17.</strong> 通用铸造</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-swapping.html"><strong aria-hidden="true">18.</strong> 通用交换</a></li><li class="chapter-item expanded "><a href="../milestone_2/quoter-contract.html"><strong aria-hidden="true">19.</strong> 报价合约</a></li><li class="chapter-item expanded "><a href="../milestone_2/user-interface.html"><strong aria-hidden="true">20.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 3. 跨Tick交换</li><li class="chapter-item expanded "><a href="../milestone_3/introduction.html"><strong aria-hidden="true">21.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_3/different-ranges.html"><strong aria-hidden="true">22.</strong> 不同价格范围</a></li><li class="chapter-item expanded "><a href="../milestone_3/cross-tick-swaps.html"><strong aria-hidden="true">23.</strong> Cross-Tick 交换</a></li><li class="chapter-item expanded "><a href="../milestone_3/slippage-protection.html"><strong aria-hidden="true">24.</strong> 滑点保护</a></li><li class="chapter-item expanded "><a href="../milestone_3/liquidity-calculation.html"><strong aria-hidden="true">25.</strong> 流动性计算</a></li><li class="chapter-item expanded "><a href="../milestone_3/more-on-fixed-point-numbers.html"><strong aria-hidden="true">26.</strong> 关于定点数的更多内容</a></li><li class="chapter-item expanded "><a href="../milestone_3/flash-loans.html"><strong aria-hidden="true">27.</strong> 闪电贷</a></li><li class="chapter-item expanded "><a href="../milestone_3/user-interface.html"><strong aria-hidden="true">28.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 4. 多池交换</li><li class="chapter-item expanded "><a href="../milestone_4/introduction.html"><strong aria-hidden="true">29.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_4/factory-contract.html"><strong aria-hidden="true">30.</strong> 工厂合约</a></li><li class="chapter-item expanded "><a href="../milestone_4/path.html"><strong aria-hidden="true">31.</strong> 交换路径</a></li><li class="chapter-item expanded "><a href="../milestone_4/multi-pool-swaps.html"><strong aria-hidden="true">32.</strong> 多池交换</a></li><li class="chapter-item expanded "><a href="../milestone_4/user-interface.html"><strong aria-hidden="true">33.</strong> 用户界面</a></li><li class="chapter-item expanded "><a href="../milestone_4/tick-rounding.html"><strong aria-hidden="true">34.</strong> Tick舍入</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 5. 费用和价格预言机</li><li class="chapter-item expanded "><a href="../milestone_5/introduction.html"><strong aria-hidden="true">35.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_5/swap-fees.html"><strong aria-hidden="true">36.</strong> 交换费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/flash-loan-fees.html"><strong aria-hidden="true">37.</strong> 闪电贷费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/protocol-fees.html"><strong aria-hidden="true">38.</strong> 协议费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/price-oracle.html"><strong aria-hidden="true">39.</strong> 价格预言机</a></li><li class="chapter-item expanded "><a href="../milestone_5/user-interface.html"><strong aria-hidden="true">40.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 6: NFT 头寸</li><li class="chapter-item expanded "><a href="../milestone_6/introduction.html"><strong aria-hidden="true">41.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_6/erc721-overview.html"><strong aria-hidden="true">42.</strong> ERC721概述</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-manager.html"><strong aria-hidden="true">43.</strong> NFT管理器</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-renderer.html" class="active"><strong aria-hidden="true">44.</strong> NFT渲染器</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Uniswap V3 Development Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book/edit/main/src/milestone_6/nft-renderer.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="nft-renderer"><a class="header" href="#nft-renderer">NFT Renderer</a></h1>
<p>Now we need to build an NFT renderer: a library that will handle calls to <code>tokenURI</code> in the NFT manager contract. It will render JSON metadata and an SVG for each minted token. As we discussed earlier, we'll use the data URI format, which requires base64 encoding–this means we'll need a base64 encoder in Solidity. But first, let's look at what our tokens will look like.</p>
<h2 id="svg-template"><a class="header" href="#svg-template">SVG Template</a></h2>
<p>I built this simplified variation of the Uniswap V3 NFTs:</p>
<p><img src="images/nft_template.png" alt="SVG template for NFT tokens" /></p>
<p>This is what its code looks like;</p>
<pre><code class="language-svg">&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 300 480&quot;&gt;
  &lt;style&gt;
    .tokens {
      font: bold 30px sans-serif;
    }

    .fee {
      font: normal 26px sans-serif;
    }

    .tick {
      font: normal 18px sans-serif;
    }
  &lt;/style&gt;

  &lt;rect width=&quot;300&quot; height=&quot;480&quot; fill=&quot;hsl(330,40%,40%)&quot; /&gt;
  &lt;rect x=&quot;30&quot; y=&quot;30&quot; width=&quot;240&quot; height=&quot;420&quot; rx=&quot;15&quot; ry=&quot;15&quot; fill=&quot;hsl(330,90%,50%)&quot; stroke=&quot;#000&quot; /&gt;

  &lt;rect x=&quot;30&quot; y=&quot;87&quot; width=&quot;240&quot; height=&quot;42&quot; /&gt;
  &lt;text x=&quot;39&quot; y=&quot;120&quot; class=&quot;tokens&quot; fill=&quot;#fff&quot;&gt;
    WETH/USDC
  &lt;/text&gt;

  &lt;rect x=&quot;30&quot; y=&quot;132&quot; width=&quot;240&quot; height=&quot;30&quot; /&gt;
  &lt;text x=&quot;39&quot; y=&quot;120&quot; dy=&quot;36&quot; class=&quot;fee&quot; fill=&quot;#fff&quot;&gt;
    0.05%
  &lt;/text&gt;

  &lt;rect x=&quot;30&quot; y=&quot;342&quot; width=&quot;240&quot; height=&quot;24&quot; /&gt;
  &lt;text x=&quot;39&quot; y=&quot;360&quot; class=&quot;tick&quot; fill=&quot;#fff&quot;&gt;
    Lower tick: 123456
  &lt;/text&gt;

  &lt;rect x=&quot;30&quot; y=&quot;372&quot; width=&quot;240&quot; height=&quot;24&quot; /&gt;
  &lt;text x=&quot;39&quot; y=&quot;360&quot; dy=&quot;30&quot; class=&quot;tick&quot; fill=&quot;#fff&quot;&gt;
    Upper tick: 123456
  &lt;/text&gt;
&lt;/svg&gt;
</code></pre>
<p>This is a simple SVG template, and we're going to make a Solidity contract that fills the fields in this template and returns it in <code>tokenURI</code>. The fields that will be filled uniquely for each token:</p>
<ol>
<li>the color of the background, which is set in the first two <code>rect</code>s; the hue component (330 in the template) will be unique for each token;</li>
<li>the names of the tokens of a pool the position belongs to (WETH/USDC in the template);</li>
<li>the fee of a pool (0.05%);</li>
<li>tick values of the boundaries of the position (123456).</li>
</ol>
<p>Here are examples of NFTs our contract will be able to produce:</p>
<p><img src="images/nft_example_2.png" alt="NFT example 1" />
<img src="images/nft_example_3.png" alt="NFT example 2" /></p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Solidity doesn't provide a native Base64 encoding tool so we'll use a third-party one. Specifically, we'll use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Base64.sol">the one from OpenZeppelin</a>.</p>
<p>Another tedious thing about Solidity is that it has very poor support for operations with strings. For example, there's no way to convert integers to strings–but we need that to render pool fee and position ticks in the SVG template. We'll use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol">the Strings library from OpenZeppelin</a> to do that.</p>
<h2 id="format-of-the-result"><a class="header" href="#format-of-the-result">Format of the Result</a></h2>
<p>The data produced by the renderer will have this format:</p>
<pre><code>data:application/json;base64,BASE64_ENCODED_JSON
</code></pre>
<p>The JSON will look like this:</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;Uniswap V3 Position&quot;,
  &quot;description&quot;: &quot;USDC/DAI 0.05%, Lower tick: -520, Upper text: 490&quot;,
  &quot;image&quot;: &quot;BASE64_ENCODED_SVG&quot;
}
</code></pre>
<p>The image will be the above SVG template filled with position data and encoded in Base64.</p>
<h2 id="implementing-the-renderer"><a class="header" href="#implementing-the-renderer">Implementing the Renderer</a></h2>
<p>We'll implement the renderer in a separate library contract to not make the NFT manager contract too noisy:</p>
<pre><code class="language-solidity">library NFTRenderer {
    struct RenderParams {
        address pool;
        address owner;
        int24 lowerTick;
        int24 upperTick;
        uint24 fee;
    }

    function render(RenderParams memory params) {
        ...
    }
}
</code></pre>
<p>In the <code>render</code> function, we'll first render an SVG, then a JSON. To keep the code cleaner, we'll break down each step into smaller steps.</p>
<p>We begin with fetching token symbols:</p>
<pre><code class="language-solidity">function render(RenderParams memory params) {
    IUniswapV3Pool pool = IUniswapV3Pool(params.pool);
    IERC20 token0 = IERC20(pool.token0());
    IERC20 token1 = IERC20(pool.token1());
    string memory symbol0 = token0.symbol();
    string memory symbol1 = token1.symbol();

    ...
</code></pre>
<h3 id="svg-rendering"><a class="header" href="#svg-rendering">SVG Rendering</a></h3>
<p>Then we can render the SVG template:</p>
<pre><code class="language-solidity">string memory image = string.concat(
    &quot;&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 480'&gt;&quot;,
    &quot;&lt;style&gt;.tokens { font: bold 30px sans-serif; }&quot;,
    &quot;.fee { font: normal 26px sans-serif; }&quot;,
    &quot;.tick { font: normal 18px sans-serif; }&lt;/style&gt;&quot;,
    renderBackground(params.owner, params.lowerTick, params.upperTick),
    renderTop(symbol0, symbol1, params.fee),
    renderBottom(params.lowerTick, params.upperTick),
    &quot;&lt;/svg&gt;&quot;
);
</code></pre>
<p>The template is broken down into multiple steps:</p>
<ol>
<li>first comes the header, which includes the CSS styles;</li>
<li>then the background is rendered;</li>
<li>then the top position information is rendered (token symbols and fee);</li>
<li>finally, the bottom information is rendered (position ticks).</li>
</ol>
<p>The background is simply two <code>rect</code>s. To render them we need to find the unique hue of this token and then we concatenate all the pieces together:</p>
<pre><code class="language-solidity">function renderBackground(
    address owner,
    int24 lowerTick,
    int24 upperTick
) internal pure returns (string memory background) {
    bytes32 key = keccak256(abi.encodePacked(owner, lowerTick, upperTick));
    uint256 hue = uint256(key) % 360;

    background = string.concat(
        '&lt;rect width=&quot;300&quot; height=&quot;480&quot; fill=&quot;hsl(',
        Strings.toString(hue),
        ',40%,40%)&quot;/&gt;',
        '&lt;rect x=&quot;30&quot; y=&quot;30&quot; width=&quot;240&quot; height=&quot;420&quot; rx=&quot;15&quot; ry=&quot;15&quot; fill=&quot;hsl(',
        Strings.toString(hue),
        ',100%,50%)&quot; stroke=&quot;#000&quot;/&gt;'
    );
}
</code></pre>
<p>The top template renders token symbols and pool fees:</p>
<pre><code class="language-solidity">function renderTop(
    string memory symbol0,
    string memory symbol1,
    uint24 fee
) internal pure returns (string memory top) {
    top = string.concat(
        '&lt;rect x=&quot;30&quot; y=&quot;87&quot; width=&quot;240&quot; height=&quot;42&quot;/&gt;',
        '&lt;text x=&quot;39&quot; y=&quot;120&quot; class=&quot;tokens&quot; fill=&quot;#fff&quot;&gt;',
        symbol0,
        &quot;/&quot;,
        symbol1,
        &quot;&lt;/text&gt;&quot;
        '&lt;rect x=&quot;30&quot; y=&quot;132&quot; width=&quot;240&quot; height=&quot;30&quot;/&gt;',
        '&lt;text x=&quot;39&quot; y=&quot;120&quot; dy=&quot;36&quot; class=&quot;fee&quot; fill=&quot;#fff&quot;&gt;',
        feeToText(fee),
        &quot;&lt;/text&gt;&quot;
    );
}
</code></pre>
<p>Fees are rendered as numbers with a fractional part. Since all possible fees are known in advance we don't need to convert integers to fractional numbers and can simply hardcode the values:</p>
<pre><code class="language-solidity">function feeToText(uint256 fee)
    internal
    pure
    returns (string memory feeString)
{
    if (fee == 500) {
        feeString = &quot;0.05%&quot;;
    } else if (fee == 3000) {
        feeString = &quot;0.3%&quot;;
    }
}
</code></pre>
<p>In the bottom part, we render position ticks:</p>
<pre><code class="language-solidity">function renderBottom(int24 lowerTick, int24 upperTick)
    internal
    pure
    returns (string memory bottom)
{
    bottom = string.concat(
        '&lt;rect x=&quot;30&quot; y=&quot;342&quot; width=&quot;240&quot; height=&quot;24&quot;/&gt;',
        '&lt;text x=&quot;39&quot; y=&quot;360&quot; class=&quot;tick&quot; fill=&quot;#fff&quot;&gt;Lower tick: ',
        tickToText(lowerTick),
        &quot;&lt;/text&gt;&quot;,
        '&lt;rect x=&quot;30&quot; y=&quot;372&quot; width=&quot;240&quot; height=&quot;24&quot;/&gt;',
        '&lt;text x=&quot;39&quot; y=&quot;360&quot; dy=&quot;30&quot; class=&quot;tick&quot; fill=&quot;#fff&quot;&gt;Upper tick: ',
        tickToText(upperTick),
        &quot;&lt;/text&gt;&quot;
    );
}
</code></pre>
<p>Since ticks can be positive and negative, we need to render them properly (with or without the minus sign):</p>
<pre><code class="language-solidity">function tickToText(int24 tick)
    internal
    pure
    returns (string memory tickString)
{
    tickString = string.concat(
        tick &lt; 0 ? &quot;-&quot; : &quot;&quot;,
        tick &lt; 0
            ? Strings.toString(uint256(uint24(-tick)))
            : Strings.toString(uint256(uint24(tick)))
    );
}
</code></pre>
<h3 id="json-rendering"><a class="header" href="#json-rendering">JSON Rendering</a></h3>
<p>Now, let's return to the <code>render</code> function and render the JSON. First, we need to render a token description:</p>
<pre><code class="language-solidity">function render(RenderParams memory params) {
    ... SVG rendering ...

    string memory description = renderDescription(
        symbol0,
        symbol1,
        params.fee,
        params.lowerTick,
        params.upperTick
    );

    ...
</code></pre>
<p>A token description is a text string that contains all the same information that we render in the token's SVG:</p>
<pre><code class="language-solidity">function renderDescription(
    string memory symbol0,
    string memory symbol1,
    uint24 fee,
    int24 lowerTick,
    int24 upperTick
) internal pure returns (string memory description) {
    description = string.concat(
        symbol0,
        &quot;/&quot;,
        symbol1,
        &quot; &quot;,
        feeToText(fee),
        &quot;, Lower tick: &quot;,
        tickToText(lowerTick),
        &quot;, Upper text: &quot;,
        tickToText(upperTick)
    );
}
</code></pre>
<p>We can now assemble the JSON metadata:</p>
<pre><code class="language-solidity">function render(RenderParams memory params) {
    string memory image = ...SVG rendering...
    string memory description = ...description rendering...

    string memory json = string.concat(
        '{&quot;name&quot;:&quot;Uniswap V3 Position&quot;,',
        '&quot;description&quot;:&quot;',
        description,
        '&quot;,',
        '&quot;image&quot;:&quot;data:image/svg+xml;base64,',
        Base64.encode(bytes(image)),
        '&quot;}'
    );
</code></pre>
<p>And, finally, we can return the result:</p>
<pre><code class="language-solidity">return
    string.concat(
        &quot;data:application/json;base64,&quot;,
        Base64.encode(bytes(json))
    );
</code></pre>
<h3 id="filling-the-gap-in-tokenuri"><a class="header" href="#filling-the-gap-in-tokenuri">Filling the Gap in <code>tokenURI</code></a></h3>
<p>Now we're ready to return to the <code>tokenURI</code> function in the NFT manager contract and add the actual rendering:</p>
<pre><code class="language-solidity">function tokenURI(uint256 tokenId)
    public
    view
    override
    returns (string memory)
{
    TokenPosition memory tokenPosition = positions[tokenId];
    if (tokenPosition.pool == address(0x00)) revert WrongToken();

    IUniswapV3Pool pool = IUniswapV3Pool(tokenPosition.pool);

    return
        NFTRenderer.render(
            NFTRenderer.RenderParams({
                pool: tokenPosition.pool,
                owner: address(this),
                lowerTick: tokenPosition.lowerTick,
                upperTick: tokenPosition.upperTick,
                fee: pool.fee()
            })
        );
}
</code></pre>
<h1 id="gas-costs"><a class="header" href="#gas-costs">Gas Costs</a></h1>
<p>With all its benefits, storing data on-chain has a huge disadvantage: contract deployments become very expensive. When deploying a contract, you pay for the size of the contract, and all the strings and templates increase gas spending significantly. This gets even worse the more advanced your SVGs are: the more there are shapes, CSS styles, animations, etc. the more expensive it gets.</p>
<p>Keep in mind that the NFT renderer we implemented above is not gas optimized: you can see the repetitive <code>rect</code> and <code>text</code> tag strings that can be extracted into internal functions. I sacrificed gas efficiency for the readability of the contract.  In real NFT projects that store all data on-chain, code readability is usually very poor due to heavy gas cost optimizations.</p>
<h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<p>The last thing I wanted to focus on here is how we can test the NFT images. It's very important to keep all changes in NFT images tracked to ensure no change breaks rendering. For this, we need a way to test the output of <code>tokenURI</code> and its different variations (we can even pre-render the whole collection and have tests to ensure no image gets broken during development).</p>
<p>To test the output of <code>tokenURI</code>, I added this custom assertion:</p>
<pre><code class="language-solidity">assertTokenURI(
    nft.tokenURI(tokenId0),
    &quot;tokenuri0&quot;,
    &quot;invalid token URI&quot;
);
</code></pre>
<p>The first argument is the actual output and the second argument is the name of the file that stores the expected one. The assertion loads the content of the file and compares it with the actual one:</p>
<pre><code class="language-solidity">function assertTokenURI(
    string memory actual,
    string memory expectedFixture,
    string memory errMessage
) internal {
    string memory expected = vm.readFile(
        string.concat(&quot;./test/fixtures/&quot;, expectedFixture)
    );

    assertEq(actual, string(expected), errMessage);
}
</code></pre>
<p>We can do this in Solidity thanks to the <code>vm.readFile()</code> cheat code provided by the <code>forge-std</code> library, which is a helper library that comes with Forge. Not only this is simple and convenient, but this is also secure: we can configure filesystem permissions to allow only permitted file operations. Specifically, to make the above test work, we need to add this
<code>fs_permissions</code> rule to <code>foundry.toml</code>:</p>
<pre><code class="language-toml">fs_permissions = [{access='read',path='.'}]
</code></pre>
<p>And this is how you can read the SVG from a <code>tokenURI</code> fixture:</p>
<pre><code class="language-shell">$ cat test/fixtures/tokenuri0 \
    | awk -F ',' '{print $2}' \
    | base64 -d - \
    | jq -r .image \
    | awk -F ',' '{print $2}' \
    | base64 -d - &gt; nft.svg \
    &amp;&amp; open nft.svg
</code></pre>
<blockquote>
<p>Ensure you have <a href="https://stedolan.github.io/jq/">jq tool</a> installed.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../milestone_6/nft-manager.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../milestone_6/nft-manager.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
