<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>工厂合约 - Uniswap V3 Development Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A book that teaches how to build a clone of Uniswap V3 in Solidity from scratch.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Uniswap V3 开发手册</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 0. 背景</li><li class="chapter-item expanded "><a href="../milestone_0/introduction-to-markets.html"><strong aria-hidden="true">1.</strong> 市场介绍</a></li><li class="chapter-item expanded "><a href="../milestone_0/constant-function-market-maker.html"><strong aria-hidden="true">2.</strong> 恒定函数做市商</a></li><li class="chapter-item expanded "><a href="../milestone_0/uniswap-v3.html"><strong aria-hidden="true">3.</strong> Uniswap V3</a></li><li class="chapter-item expanded "><a href="../milestone_0/dev-environment.html"><strong aria-hidden="true">4.</strong> 开发环境</a></li><li class="chapter-item expanded "><a href="../milestone_0/what-we-will-build.html"><strong aria-hidden="true">5.</strong> 我们将要构建什么</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 1. 第一次交换</li><li class="chapter-item expanded "><a href="../milestone_1/introduction.html"><strong aria-hidden="true">6.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_1/calculating-liquidity.html"><strong aria-hidden="true">7.</strong> 计算流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/providing-liquidity.html"><strong aria-hidden="true">8.</strong> 提供流动性</a></li><li class="chapter-item expanded "><a href="../milestone_1/first-swap.html"><strong aria-hidden="true">9.</strong> 第一次交换</a></li><li class="chapter-item expanded "><a href="../milestone_1/manager-contract.html"><strong aria-hidden="true">10.</strong> 管理合约</a></li><li class="chapter-item expanded "><a href="../milestone_1/deployment.html"><strong aria-hidden="true">11.</strong> 部署</a></li><li class="chapter-item expanded "><a href="../milestone_1/user-interface.html"><strong aria-hidden="true">12.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 2. 第二次交换</li><li class="chapter-item expanded "><a href="../milestone_2/introduction.html"><strong aria-hidden="true">13.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_2/output-amount-calculation.html"><strong aria-hidden="true">14.</strong> 输出金额计算</a></li><li class="chapter-item expanded "><a href="../milestone_2/math-in-solidity.html"><strong aria-hidden="true">15.</strong> Solidity中的数学运算</a></li><li class="chapter-item expanded "><a href="../milestone_2/tick-bitmap-index.html"><strong aria-hidden="true">16.</strong> Tick位图索引</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-minting.html"><strong aria-hidden="true">17.</strong> 通用铸造</a></li><li class="chapter-item expanded "><a href="../milestone_2/generalize-swapping.html"><strong aria-hidden="true">18.</strong> 通用交换</a></li><li class="chapter-item expanded "><a href="../milestone_2/quoter-contract.html"><strong aria-hidden="true">19.</strong> 报价合约</a></li><li class="chapter-item expanded "><a href="../milestone_2/user-interface.html"><strong aria-hidden="true">20.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 3. 跨Tick交换</li><li class="chapter-item expanded "><a href="../milestone_3/introduction.html"><strong aria-hidden="true">21.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_3/different-ranges.html"><strong aria-hidden="true">22.</strong> 不同价格范围</a></li><li class="chapter-item expanded "><a href="../milestone_3/cross-tick-swaps.html"><strong aria-hidden="true">23.</strong> Cross-Tick 交换</a></li><li class="chapter-item expanded "><a href="../milestone_3/slippage-protection.html"><strong aria-hidden="true">24.</strong> 滑点保护</a></li><li class="chapter-item expanded "><a href="../milestone_3/liquidity-calculation.html"><strong aria-hidden="true">25.</strong> 流动性计算</a></li><li class="chapter-item expanded "><a href="../milestone_3/more-on-fixed-point-numbers.html"><strong aria-hidden="true">26.</strong> 关于定点数的更多内容</a></li><li class="chapter-item expanded "><a href="../milestone_3/flash-loans.html"><strong aria-hidden="true">27.</strong> 闪电贷</a></li><li class="chapter-item expanded "><a href="../milestone_3/user-interface.html"><strong aria-hidden="true">28.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 4. 多池交换</li><li class="chapter-item expanded "><a href="../milestone_4/introduction.html"><strong aria-hidden="true">29.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_4/factory-contract.html" class="active"><strong aria-hidden="true">30.</strong> 工厂合约</a></li><li class="chapter-item expanded "><a href="../milestone_4/path.html"><strong aria-hidden="true">31.</strong> 交换路径</a></li><li class="chapter-item expanded "><a href="../milestone_4/multi-pool-swaps.html"><strong aria-hidden="true">32.</strong> 多池交换</a></li><li class="chapter-item expanded "><a href="../milestone_4/user-interface.html"><strong aria-hidden="true">33.</strong> 用户界面</a></li><li class="chapter-item expanded "><a href="../milestone_4/tick-rounding.html"><strong aria-hidden="true">34.</strong> Tick舍入</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 5. 费用和价格预言机</li><li class="chapter-item expanded "><a href="../milestone_5/introduction.html"><strong aria-hidden="true">35.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_5/swap-fees.html"><strong aria-hidden="true">36.</strong> 交换费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/flash-loan-fees.html"><strong aria-hidden="true">37.</strong> 闪电贷费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/protocol-fees.html"><strong aria-hidden="true">38.</strong> 协议费用</a></li><li class="chapter-item expanded "><a href="../milestone_5/price-oracle.html"><strong aria-hidden="true">39.</strong> 价格预言机</a></li><li class="chapter-item expanded "><a href="../milestone_5/user-interface.html"><strong aria-hidden="true">40.</strong> 用户界面</a></li><li class="chapter-item expanded affix "><li class="part-title">里程碑 6: NFT 头寸</li><li class="chapter-item expanded "><a href="../milestone_6/introduction.html"><strong aria-hidden="true">41.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../milestone_6/erc721-overview.html"><strong aria-hidden="true">42.</strong> ERC721概述</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-manager.html"><strong aria-hidden="true">43.</strong> NFT管理器</a></li><li class="chapter-item expanded "><a href="../milestone_6/nft-renderer.html"><strong aria-hidden="true">44.</strong> NFT渲染器</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Uniswap V3 Development Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Jeiwan/uniswapv3-book/edit/main/src/milestone_4/factory-contract.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="factory-contract"><a class="header" href="#factory-contract">Factory Contract</a></h1>
<p>Uniswap is designed in a way that assumes many discrete Pool contracts, with each pool handling swaps of one token pair.  This looks problematic when we want to swap between two tokens that don’t have a pool–if there’s no pool, no swaps are possible. However, we can still do intermediate swaps: first swap to a token that has pairs with either of the tokens and then swap this token to the target token. This can also go deeper and have more intermediate tokens. However, doing this manually is cumbersome, and, luckily, we can make the process easier by implementing it in our smart contracts.</p>
<p>The Factory contract is a contract that serves multiple purposes:</p>
<ol>
<li>It acts as a centralized registry of Pool contracts. Using a factory, you can find all deployed pools, their tokens, and addresses.</li>
<li>It simplifies the deployment of Pool contracts. EVM allows deployment of smart contracts from smart contracts–Factory uses this feature to make pool deployment a breeze.</li>
<li>It makes pool addresses predictable and allows to compute them without making calls to the registry. This makes
pools easily discoverable.</li>
</ol>
<p>Let’s build the Factory contract! But before doing this, we need to learn something new.</p>
<h2 id="the-create-and-create2-opcodes"><a class="header" href="#the-create-and-create2-opcodes">The <code>CREATE</code> and <code>CREATE2</code> Opcodes</a></h2>
<p>EVM has two ways of deploying contracts: via <code>CREATE</code> or via <code>CREATE2</code> opcode. The only difference between them is how new contract address is generated:</p>
<ol>
<li><code>CREATE</code> uses the deployer’s account <code>nonce</code> to generate a contract address (in pseudocode):
<pre><code>KECCAK256(deployer.address, deployer.nonce)
</code></pre>
<code>nonce</code> is an account-specific counter of transactions. Using <code>nonce</code> in new contract address generation makes it hard to compute an address in other contracts or off-chain apps, mainly because, to find the nonce a contract was deployed at, one needs to scan historical account transactions.</li>
<li><code>CREATE2</code> uses a custom <em>salt</em> to generate a contract address. This is just an arbitrary sequence of bytes chosen by a developer, which is used to make address generation deterministic (and reduces the chance of a collision).
<pre><code>KECCAK256(deployer.address, salt, contractCodeHash)
</code></pre>
</li>
</ol>
<p>We need to know the difference because Factory uses <code>CREATE2</code> when deploying Pool contracts so pools get unique and deterministic addresses that can be computed in other contracts and off-chain apps. Specifically, for salt, Factory computes a hash using these pool parameters:</p>
<pre><code class="language-solidity">keccak256(abi.encodePacked(token0, token1, tickSpacing))
</code></pre>
<p><code>token0</code> and <code>token1</code> are the addresses of pool tokens, and <code>tickSpacing</code> is something we’re going to learn about next.</p>
<h2 id="tick-spacing"><a class="header" href="#tick-spacing">Tick Spacing</a></h2>
<p>Recall the loop in the <code>swap</code> function:</p>
<pre><code class="language-solidity">while (
    state.amountSpecifiedRemaining &gt; 0 &amp;&amp;
    state.sqrtPriceX96 != sqrtPriceLimitX96
) {
    ...
    (step.nextTick, ) = tickBitmap.nextInitializedTickWithinOneWord(...);
    (state.sqrtPriceX96, step.amountIn, step.amountOut) = SwapMath.computeSwapStep(...);
    ...
}
</code></pre>
<p>This loop finds initialized ticks that have some liquidity by iterating them in either of the directions. This iterating, however, is an expensive operation: if a tick is far away, the code would need to pass all the ticks between the current and the target one, which consumes gas. To make this loop more gas-efficient, Uniswap pools have the <code>tickSpacing</code> setting, which sets, as the name suggests, the distance between ticks: the wider the distance, the more gas-efficient swaps are.</p>
<p>However, the wider the tick spacing the lower the precision. Low volatility pairs (e.g. stablecoin pairs) need higher precision because price movements are narrow in such pairs. Medium and high volatility pairs need lower precision since price movements are wide in such pairs. To handle this diversity, Uniswap allows to pick a tick spacing when a pair is deployed. Uniswap allows deployers to choose from these options: 10, 60, or 200. And we’ll have only 10 and 60 for simplicity.</p>
<p>In technical terms, tick indexes can only be multiples of <code>tickSpacing</code>: if <code>tickSpacing</code> is 10, only multiples of 10 will be valid as tick indexes (10, 20, 5000, 5010, but not 8, 12, 5001, etc.). However, and this is important, this doesn’t apply to the current price–it can still be any tick because we want it to be as precise as possible. <code>tickSpacing</code> is only applied to price ranges.</p>
<p>Thus, each pool is uniquely identified by this set of parameters:</p>
<ol>
<li><code>token0</code>,</li>
<li><code>token1</code>,</li>
<li><code>tickSpacing</code>;</li>
</ol>
<blockquote>
<p>And, yes, there can be pools with the same tokens but different tick spacings.</p>
</blockquote>
<p>The Factory contract uses this set of parameters as a unique identifier of a pool and passes it as a salt to generate a new pool contract address.</p>
<blockquote>
<p>From now on, we’ll assume the tick spacing of 60 for all our pools, and we’ll use 10 for stablecoin pairs. Please notice that only ticks divisible by these values can be flagged as initialized in the ticks bitmap. For example, only ticks -120, -60, 0, 60, 120, etc. can be initialized and used in liquidity ranges when tick spacing is 60.</p>
</blockquote>
<h2 id="factory-implementation"><a class="header" href="#factory-implementation">Factory Implementation</a></h2>
<p>In the constructor of Factory, we need to initialize supported tick spacings:</p>
<pre><code class="language-solidity">// src/UniswapV3Factory.sol
contract UniswapV3Factory is IUniswapV3PoolDeployer {
    mapping(uint24 =&gt; bool) public tickSpacings;
    constructor() {
        tickSpacings[10] = true;
        tickSpacings[60] = true;
    }

    ...
</code></pre>
<blockquote>
<p>We could’ve made them constants, but we’ll need to have it as a mapping for a later milestone (tick spacings will have different swap fee amounts).</p>
</blockquote>
<p>The Factory contract is a contract with only one function <code>createPool</code>. The function begins with the necessary checks we need to make before creating a pool:</p>
<pre><code class="language-solidity">// src/UniswapV3Factory.sol
contract UniswapV3Factory is IUniswapV3PoolDeployer {
    PoolParameters public parameters;
    mapping(address =&gt; mapping(address =&gt; mapping(uint24 =&gt; address)))
        public pools;

    ...

    function createPool(
        address tokenX,
        address tokenY,
        uint24 tickSpacing
    ) public returns (address pool) {
        if (tokenX == tokenY) revert TokensMustBeDifferent();
        if (!tickSpacings[tickSpacing]) revert UnsupportedTickSpacing();

        (tokenX, tokenY) = tokenX &lt; tokenY
            ? (tokenX, tokenY)
            : (tokenY, tokenX);

        if (tokenX == address(0)) revert TokenXCannotBeZero();
        if (pools[tokenX][tokenY][tickSpacing] != address(0))
            revert PoolAlreadyExists();
        
        ...
</code></pre>
<p>Notice that this is the first time when we’re sorting tokens:</p>
<pre><code class="language-solidity">(tokenX, tokenY) = tokenX &lt; tokenY
    ? (tokenX, tokenY)
    : (tokenY, tokenX);
</code></pre>
<p>From now on, we’ll also expect pool token addresses to be sorted, i.e. <code>token0</code> goes before <code>token1</code> when sorted. We’ll enforce this to make salt (and pool addresses) computation consistent.</p>
<blockquote>
<p>This change also affects how we deploy tokens in tests and the deployment script: we need to ensure that WETH is always <code>token0</code> to make price calculations simpler in Solidity (otherwise, we’d need to use fractional prices, like 1/5000). If WETH is not <code>token0</code> in your tests, change the order of token deployments.</p>
</blockquote>
<p>After that, we prepare pool parameters and deploy a pool:</p>
<pre><code class="language-solidity">parameters = PoolParameters({
    factory: address(this),
    token0: tokenX,
    token1: tokenY,
    tickSpacing: tickSpacing
});

pool = address(
    new UniswapV3Pool{
        salt: keccak256(abi.encodePacked(tokenX, tokenY, tickSpacing))
    }()
);

delete parameters;
</code></pre>
<p>This piece looks weird because <code>parameters</code> is not used. Uniswap uses <a href="https://en.wikipedia.org/wiki/Inversion_of_control">Inversion of Control</a> to pass parameters to a pool during deployment. Let’s look at the updated Pool contract constructor:</p>
<pre><code class="language-solidity">// src/UniswapV3Pool.sol
contract UniswapV3Pool is IUniswapV3Pool {
    ...
    constructor() {
        (factory, token0, token1, tickSpacing) = IUniswapV3PoolDeployer(
            msg.sender
        ).parameters();
    }
    ..
}
</code></pre>
<p>Aha! Pool expects its deployer to implement the <code>IUniswapV3PoolDeployer</code> interface (which only defines the <code>parameters()</code> getter) and calls it in the constructor during deployment to get the parameters. This is what the flow looks like:</p>
<ol>
<li><code>Factory</code>: defines <code>parameters</code> state variable (implements <code>IUniswapV3PoolDeployer</code>) and sets it before deploying a pool.</li>
<li><code>Factory</code>: deploys a pool.</li>
<li><code>Pool</code>: in the constructor, calls the <code>parameters()</code> function on its deployer and expects that pool parameters are returned.</li>
<li><code>Factory</code>: calls <code>delete parameters;</code> to clean up the slot of the <code>parameters</code> state variable and to reduce gas consumption. This is a temporary state variable that has a value only during a call to <code>createPool()</code>.</li>
</ol>
<p>After a pool is created, we keep it in the <code>pools</code> mapping (so it can be found by its tokens) and emit an event:</p>
<pre><code class="language-solidity">    pools[tokenX][tokenY][tickSpacing] = pool;
    pools[tokenY][tokenX][tickSpacing] = pool;

    emit PoolCreated(tokenX, tokenY, tickSpacing, pool);
}
</code></pre>
<h2 id="pool-initialization"><a class="header" href="#pool-initialization">Pool Initialization</a></h2>
<p>As you have noticed from the code above, we no longer set <code>sqrtPriceX96</code> and <code>tick</code> in Pool’s constructor–this is now done in a separate function, <code>initialize</code>, that needs to be called after the pool is deployed:</p>
<pre><code class="language-solidity">// src/UniswapV3Pool.sol
function initialize(uint160 sqrtPriceX96) public {
    if (slot0.sqrtPriceX96 != 0) revert AlreadyInitialized();

    int24 tick = TickMath.getTickAtSqrtRatio(sqrtPriceX96);

    slot0 = Slot0({sqrtPriceX96: sqrtPriceX96, tick: tick});
}
</code></pre>
<p>So this is how we deploy pools now:</p>
<pre><code class="language-solidity">UniswapV3Factory factory = new UniswapV3Factory();
UniswapV3Pool pool = UniswapV3Pool(factory.createPool(token0, token1, tickSpacing));
pool.initialize(sqrtP(currentPrice));
</code></pre>
<h2 id="the-pooladdress-library"><a class="header" href="#the-pooladdress-library">The <code>PoolAddress</code> Library</a></h2>
<p>Let’s now implement a library that will help us calculate pool contract addresses from other contracts. This library will have only one function, <code>computeAddress</code>:</p>
<pre><code class="language-solidity">// src/lib/PoolAddress.sol
library PoolAddress {
    function computeAddress(
        address factory,
        address token0,
        address token1,
        uint24 tickSpacing
    ) internal pure returns (address pool) {
        require(token0 &lt; token1);
        ...
</code></pre>
<p>The function needs to know pool parameters (they’re used to build a salt) and the Factory contract address. It expects the tokens to be sorted, which we discussed above.</p>
<p>Now, the core of the function:</p>
<pre><code class="language-solidity">pool = address(
    uint160(
        uint256(
            keccak256(
                abi.encodePacked(
                    hex&quot;ff&quot;,
                    factory,
                    keccak256(
                        abi.encodePacked(token0, token1, tickSpacing)
                    ),
                    keccak256(type(UniswapV3Pool).creationCode)
                )
            )
        )
    )
);
</code></pre>
<p>This is what <code>CREATE2</code> does under the hood to calculate the new contract address. Let’s unwind it:</p>
<ol>
<li>first, we calculate salt (<code>abi.encodePacked(token0, token1, tickSpacing)</code>) and hash it;</li>
<li>then, we obtain the Pool contract code (<code>type(UniswapV3Pool).creationCode</code>) and also hash it;</li>
<li>then, we build a sequence of bytes that includes: <code>0xff</code>, the Factory contract address, hashed salt, and hashed Pool contract code;</li>
<li>we then hash the sequence and convert it to an address.</li>
</ol>
<p>These steps implement contract address generation as it’s defined in <a href="https://eips.ethereum.org/EIPS/eip-1014">EIP-1014</a>, which is the EIP that added the <code>CREATE2</code> opcode. Let’s look closer at the values that constitute the hashed byte sequence:</p>
<ol>
<li><code>0xff</code>, as defined in the EIP, is used to distinguish addresses generated by <code>CREATE</code> and <code>CREATE2</code>;</li>
<li><code>factory</code> is the address of the deployer, in our case the Factory contract;</li>
<li>salt was discussed earlier–it uniquely identifies a pool;</li>
<li>hashed contract code is needed to protect from collisions: different contracts can have the same salt, but their code
hash will be different.</li>
</ol>
<p>So, according to this scheme, a contract address is a hash of the values that uniquely identify this contract, including its deployer, code, and unique parameters. We can use this function from anywhere to find a pool address without making any external calls and without querying the factory.</p>
<h2 id="simplified-interfaces-of-manager-and-quoter"><a class="header" href="#simplified-interfaces-of-manager-and-quoter">Simplified Interfaces of Manager and Quoter</a></h2>
<p>In Manager and Quoter contracts, we no longer need to ask users for pool addresses! This makes interaction with the contracts easier because users don’t need to know pool addresses, they only need to know tokens. However, users also need to specify tick spacing because it’s included in the pool’s salt.</p>
<p>Moreover, we no longer need to ask users for the <code>zeroForOne</code> flag because we can now always figure it out thanks to tokens sorting. <code>zeroForOne</code> is true when “from token” is less than “to token”, since the pool’s <code>token0</code> is always less than <code>token1</code>. Likewise, <code>zeroForOne</code> is always false when “from token” is greater than “to token”.</p>
<blockquote>
<p>Addresses are hashes, and hashes are numbers, so we can say “less than” or “greater than” when comparing addresses.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../milestone_4/introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../milestone_4/path.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../milestone_4/introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../milestone_4/path.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
